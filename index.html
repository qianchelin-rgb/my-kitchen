<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸœ å¹¸ç¦é£Ÿå ‚ - ä¿®å¤ç‰ˆ</title>
    <style>
        :root {
            --bg: #fff8e1;
            --wood: #8d6e63;
            --wood-light: #d7ccc8;
            --primary: #ff7043;
            --green: #81c784;
            --blue: #42a5f5;
            --text: #4e342e;
            --shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        body {
            margin: 0; padding: 0; font-family: 'Microsoft YaHei', sans-serif;
            background: var(--bg); color: var(--text); height: 100vh; overflow: hidden;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        .app { display: flex; flex-direction: column; height: 100%; max-width: 500px; margin: 0 auto; background: #fffcf5; position: relative; }

        /* é¡¶éƒ¨æ  */
        .top-bar {
            padding: 15px; display: flex; justify-content: space-between;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(5px);
            border-bottom: 1px solid #eee; z-index: 10;
        }
        .badge {
            background: #fff; border: 1px solid #ddd; padding: 5px 12px;
            border-radius: 15px; font-size: 13px; font-weight: bold;
            display: flex; align-items: center; gap: 5px;
        }

        /* === åœºæ™¯åŒº === */
        .scene { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        
        .wall {
            height: 40%; background-image: radial-gradient(#e0e0e0 1px, transparent 1px);
            background-size: 20px 20px; position: relative; border-bottom: 12px solid #fff;
        }
        .window {
            position: absolute; left: 20px; top: 20px; width: 100px; height: 70px;
            background: #b3e5fc; border: 5px solid #fff; border-radius: 8px;
            box-shadow: 0 5px 0 #eee; overflow: hidden;
        }
        .window::after { content:''; position:absolute; left:50%; width:4px; height:100%; background:#fff; }
        .window::before { content:''; position:absolute; top:50%; width:100%; height:4px; background:#fff; }
        .cloud { position:absolute; top:10px; font-size:30px; opacity:0.8; animation: floatCloud 15s linear infinite; }
        @keyframes floatCloud { from{left:-40px;} to{left:120px;} }
        
        .board {
            position: absolute; right: 20px; top: 20px; width: 120px; height: 80px;
            background: #3e2723; border: 4px solid #a1887f; border-radius: 5px;
            color: #fff; text-align: center; transform: rotate(-2deg);
            display: flex; flex-direction: column; justify-content: center;
            box-shadow: var(--shadow); cursor: pointer;
        }
        .board-title { font-size: 10px; color: #ffcc80; }
        .board-icon { font-size: 32px; margin: 2px 0; }
        .board-tag { font-size: 10px; background: #e53935; display: inline-block; padding: 0 5px; border-radius: 4px; margin: 0 auto; }

        .fac-display {
            position: absolute; bottom: 10px; right: 20px; background: rgba(255,255,255,0.8);
            padding: 2px 8px; border-radius: 10px; font-size: 10px; color: #888;
        }

        .floor {
            flex: 1; background: #f5f5f5; position: relative;
            background-image: repeating-linear-gradient(45deg, transparent 0, transparent 19px, #e0e0e0 20px);
        }

        /* === é”…å…· (å±‚çº§ 5) === */
        .counter {
            position: absolute; top: -40px; left: 5%; width: 90%; height: 90px;
            background: var(--wood-light); border-bottom: 12px solid var(--wood);
            border-radius: 10px; display: flex; justify-content: space-around; align-items: flex-end;
            padding-bottom: 10px; z-index: 5; box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
        
        .stove-slot { position: relative; width: 70px; height: 60px; display: flex; justify-content: center; align-items: flex-end; }
        
        .burner {
            position: absolute; bottom: 0; width: 60px; height: 12px;
            background: #333; border-radius: 50%; border: 2px solid #555;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .pot { width: 64px; height: 50px; position: relative; cursor: pointer; transition: 0.2s; z-index: 2; margin-bottom: 5px; }
        .pot:active { transform: scale(0.95); }
        .pot.selected { transform: translateY(-15px) scale(1.1); filter: drop-shadow(0 10px 5px rgba(0,0,0,0.2)); }
        
        .pot-body {
            width: 100%; height: 100%; 
            background: linear-gradient(to right, #546e7a, #78909c 40%, #546e7a);
            border-radius: 0 0 20px 20px; border: 1px solid #37474f; position: relative; overflow: hidden;
        }
        .pot-ear { position: absolute; top: 10px; width: 10px; height: 14px; background: #37474f; border-radius: 4px; }
        .pot-ear.l { left: -8px; } .pot-ear.r { right: -8px; }
        
        .pot-lid {
            position: absolute; top: -8px; left: -2%; width: 104%; height: 16px;
            background: rgba(255,255,255,0.5); border-radius: 50%; border: 2px solid #b0bec5;
        }
        .lid-knob {
            position: absolute; top: -6px; left: 50%; transform: translateX(-50%);
            width: 14px; height: 8px; background: #3e2723; border-radius: 4px;
        }
        
        .pot-icon {
            position: absolute; top: -30px; left: 0; width: 100%; text-align: center;
            font-size: 24px; opacity: 0; transition: 0.3s; transform: translateY(10px);
        }
        .pot.has-food .pot-icon { opacity: 1; transform: translateY(0); }
        
        .pot.cooking .pot-body { background: linear-gradient(to right, #d32f2f, #ef5350 40%, #d32f2f); animation: shake 0.5s infinite; }
        .pot.done .pot-body { background: linear-gradient(to right, #388e3c, #66bb6a 40%, #388e3c); border-color: #fff; }
        .steam { position: absolute; top: -30px; left: 20px; font-size: 20px; opacity: 0; pointer-events: none; }
        .pot.cooking .steam { animation: rise 1.5s infinite; opacity: 1; }

        /* é¡¾å®¢ (å±‚çº§ 20ï¼Œç¡®ä¿åœ¨æŸœå°å‰é¢) */
        .seat-row { 
            position: absolute; top: 60px; width: 100%; display: flex; justify-content: space-around; 
            z-index: 20; /* å…³é”®ä¿®å¤ï¼šæ¯”counteré«˜ */
        }
        .seat { width: 60px; height: 60px; background: rgba(0,0,0,0.05); border-radius: 50%; position: relative; }
        .cust {
            position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; align-items: center;
            opacity: 0; transition: 0.5s; cursor: pointer;
        }
        .cust.show { opacity: 1; }
        .cust-face { font-size: 40px; filter: drop-shadow(0 3px 0 rgba(0,0,0,0.1)); }
        
        /* æ°”æ³¡ä¼˜åŒ– */
        .bubble {
            background: #fff; border: 2px solid #333; padding: 4px 10px;
            border-radius: 12px; font-size: 14px; font-weight: bold; 
            position: absolute; bottom: 100%; margin-bottom: 5px; /* ç¡®ä¿æµ®åœ¨å¤´é¡¶ */
            animation: float 2s infinite; white-space: nowrap;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .bubble::after {
            content:''; position:absolute; bottom:-5px; left:50%; transform:translateX(-50%);
            border-width: 5px 5px 0; border-style: solid; border-color: #333 transparent transparent;
        }

        /* === åº•éƒ¨èœå• === */
        .controls {
            background: #fff; padding: 15px; z-index: 30; /* æ¯”åœºæ™¯é«˜ */
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); border-radius: 20px 20px 0 0;
        }
        .home-menu-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; }
        
        .menu-btn {
            background: #f9f9f9; border: 1px solid #eee; border-radius: 15px;
            padding: 8px 5px; text-align: center; cursor: pointer; transition: 0.1s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .menu-btn:active { transform: scale(0.96); background: #eee; }
        .btn-icon { font-size: 20px; margin-bottom: 2px; }
        .btn-txt { font-size: 11px; font-weight: bold; color: #666; }
        
        .start-btn {
            grid-column: span 4; background: var(--primary); color: white; border: none;
            padding: 12px; font-size: 16px; margin-top: 5px; box-shadow: 0 4px 10px rgba(255, 112, 67, 0.3);
            flex-direction: row; gap: 8px;
        }
        .start-btn .btn-txt { color: white; font-size: 16px; }

        .save-btn { background: #e8f5e9; border-color: #c8e6c9; }
        .save-btn .btn-txt { color: #2e7d32; }

        .game-menu { display: none; overflow-x: auto; gap: 8px; padding-bottom: 5px; }
        .ing-card {
            flex: 0 0 55px; height: 65px; background: #fff; border: 1px solid #ddd;
            border-radius: 10px; display: flex; flex-direction: column; align-items: center;
            justify-content: center; cursor: pointer; position: relative;
        }
        .ing-card:active { background: #f0f0f0; }
        .ing-qty { font-size: 10px; color: #888; }

        .pot-act {
            position: absolute; bottom: 140px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; pointer-events: none; opacity: 0; transition: 0.2s; z-index: 25;
        }
        .pot-act.show { opacity: 1; pointer-events: auto; }
        .act-btn {
            border: none; padding: 8px 16px; border-radius: 20px; color: white;
            font-weight: bold; cursor: pointer; box-shadow: 0 3px 5px rgba(0,0,0,0.2);
        }

        /* === å¼¹çª— === */
        .modal-mask {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.5); z-index: 100; display: none;
            align-items: center; justify-content: center;
        }
        .modal {
            background: #fff; width: 85%; max-width: 400px; max-height: 85vh;
            border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: pop 0.3s;
            display: flex; flex-direction: column;
        }
        
        .modal-head { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-head h3 { margin: 0; font-size: 18px; }
        .close-x { font-size: 24px; cursor: pointer; color: #aaa; }
        .modal-body { padding: 15px; overflow-y: auto; flex: 1; }
        .modal-foot { padding: 15px; border-top: 1px solid #eee; background: #fff; border-radius: 0 0 20px 20px; }

        /* åˆ—è¡¨æ ·å¼ */
        .list-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .grid-item { border: 1px solid #eee; border-radius: 8px; padding: 8px; text-align: center; cursor: pointer; position: relative; }
        .grid-item.sel { background: #fff3e0; border-color: var(--primary); }
        .grid-item.locked { opacity: 0.5; filter: grayscale(1); background: #f5f5f5; cursor: not-allowed; }
        
        .stock-tag { background: #f5f5f5; color: #666; font-size: 10px; padding: 2px 6px; border-radius: 10px; display: inline-block; margin-top: 2px; font-weight: bold; }

        .ach-item { display: flex; align-items: center; padding: 12px; border: 1px solid #eee; border-radius: 12px; margin-bottom: 8px; background: #fcfcfc; }
        .ach-item.unlocked { background: #fff8e1; border-color: #ffca28; }
        .ach-icon { font-size: 30px; width: 50px; height: 50px; background: #eee; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-right: 10px; filter: grayscale(100%); opacity: 0.5; }
        .ach-item.unlocked .ach-icon { filter: grayscale(0); opacity: 1; background: #fff; border: 2px solid #ffca28; }
        .ach-info h4 { margin: 0; font-size: 14px; } .ach-info p { margin: 2px 0 0; font-size: 11px; color: #888; }
        
        .fac-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid #eee; border-radius: 10px; margin-bottom: 8px; }
        .fac-item.current { background: #e8f5e9; border-color: var(--green); }
        .up-btn { background: var(--blue); color: white; border: none; padding: 5px 10px; border-radius: 15px; font-size: 12px; cursor: pointer; }

        .recipe-row { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #f0f0f0; }
        .recipe-info { flex: 1; margin-left: 10px; }

        @keyframes shake { 0%{transform:rotate(0);} 25%{transform:rotate(3deg);} 75%{transform:rotate(-3deg);} }
        @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-3px);} }
        @keyframes rise { 0%{transform:translateY(0);opacity:0.8;} 100%{transform:translateY(-20px);opacity:0;} }
        @keyframes pop { from{transform:scale(0.9);opacity:0;} to{transform:scale(1);opacity:1;} }

        .ach-toast {
            position: fixed; top: -80px; left: 50%; transform: translateX(-50%);
            background: #fff; border-radius: 30px; padding: 8px 20px;
            box-shadow: 0 5px 20px rgba(255, 193, 7, 0.4); z-index: 200;
            display: flex; align-items: center; gap: 10px; border: 2px solid #ffca28;
            transition: top 0.5s; width: max-content;
        }
        .ach-toast.show { top: 20px; }

        .toast { position: fixed; top: 45%; left: 50%; transform: translate(-50%); background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 20px; opacity: 0; pointer-events: none; z-index: 500; transition: 0.3s; }
        .end-btn { width: 100%; text-align: center; margin-top: 10px; font-size: 12px; color: #e53935; cursor: pointer; display: none; }
        .close-x { font-size: 24px; cursor: pointer; color: #aaa; }
    </style>
</head>
<body>

<div class="app">
    <div class="top-bar">
        <div class="badge">ğŸ’° <span id="uiMoney">0</span></div>
        <div class="badge">ğŸ“… <span id="uiDay">1</span></div>
        <div class="badge" style="background:#5d4037; color:#fff; border:none;">Lv.<span id="uiLv">1</span></div>
    </div>

    <div class="scene">
        <div class="wall">
            <div class="window"><div class="cloud">â˜ï¸</div></div>
            <div class="board" onclick="toast('ä»Šæ—¥æ¨èï¼šå”®ä»·ç¿»å€ï¼')">
                <div class="board-title">TODAY</div>
                <div class="board-icon" id="trendIcon">?</div>
                <div class="board-tag">HOT</div>
            </div>
            <div class="fac-display" id="uiFacName">ğŸ  ç®€é™‹æ‘Šä½</div>
        </div>
        <div class="floor">
            <div class="counter">
                <div id="potBox" style="display:flex; width:100%; justify-content:space-around;"></div>
            </div>
            
            <div class="pot-act" id="potAct">
                <button class="act-btn" style="background:#ef5350" onclick="clearPot()">ğŸ—‘ï¸ å€’æ‰</button>
                <button class="act-btn" style="background:#ff7043" onclick="cook()">ğŸ”¥ çƒ¹é¥ª</button>
            </div>

            <!-- é¡¾å®¢å®¹å™¨ -->
            <div class="seat-row" id="seatBox"></div>
        </div>
    </div>

    <div class="controls">
        <div class="home-menu-grid" id="homeNav">
            <div class="menu-btn" onclick="openMarket()"><span class="btn-icon">ğŸ¥¦</span><span class="btn-txt">é‡‡è´­</span></div>
            <div class="menu-btn" onclick="openWarehouse()"><span class="btn-icon">ğŸ“¦</span><span class="btn-txt">ä»“åº“</span></div>
            <div class="menu-btn" onclick="openRecipes()"><span class="btn-icon">ğŸ“–</span><span class="btn-txt">é£Ÿè°±</span></div>
            <div class="menu-btn" onclick="openUpgrade()"><span class="btn-icon">ğŸ—ï¸</span><span class="btn-txt">è£…ä¿®</span></div>
            <!-- ä¿®å¤å‡½æ•°å openAchieve -->
            <div class="menu-btn" onclick="openAchieve()"><span class="btn-icon">ğŸ†</span><span class="btn-txt">æˆå°±</span></div>
            <div class="menu-btn save-btn" onclick="manualSave()"><span class="btn-icon">ğŸ’¾</span><span class="btn-txt">ä¿å­˜</span></div>
            
            <div class="menu-btn start-btn" onclick="openMenu()">
                <div class="btn-icon">ğŸ³</div><div class="btn-txt">é€‰æ‹©èœå• & å¼€å§‹è¥ä¸š</div>
            </div>
            <div style="grid-column:span 5; text-align:center; margin-top:5px;">
                <span style="font-size:10px; color:#999; cursor:pointer; text-decoration:underline;" onclick="resetGame()">âš ï¸ æ¸…é™¤å­˜æ¡£é‡å¼€</span>
            </div>
        </div>

        <div class="game-menu" id="gameNav"></div>
        <div class="end-btn" id="endBtn" onclick="endDay()">ğŸ›‘ ç»“æŸè¥ä¸šç»“ç®—</div>
    </div>
</div>

<!-- å¼¹çª— -->
<div id="modalAchieve" class="modal-mask"><div class="modal"><div class="modal-head"><h3>ğŸ† è£èª‰æ®¿å ‚</h3><span class="close-x" onclick="closeModal()">Ã—</span></div><div class="modal-body" id="achList"></div><div class="modal-foot"><button class="act-btn" style="background:#aaa;width:100%" onclick="closeModal()">å…³é—­</button></div></div></div>
<div id="modalUpgrade" class="modal-mask"><div class="modal"><div class="modal-head"><h3>ğŸ—ï¸ è®¾æ–½å‡çº§</h3><span class="close-x" onclick="closeModal()">Ã—</span></div><div class="modal-body" id="facList"></div><div class="modal-foot"><button class="act-btn" style="background:#aaa;width:100%" onclick="closeModal()">å…³é—­</button></div></div></div>
<div id="modalRecipes" class="modal-mask"><div class="modal"><div class="modal-head"><h3>ğŸ“– é£Ÿè°±å¤§å…¨</h3><span class="close-x" onclick="closeModal()">Ã—</span></div><div class="modal-body" id="recipeList"></div><div class="modal-foot"><button class="act-btn" style="background:#aaa;width:100%" onclick="closeModal()">å…³é—­</button></div></div></div>
<div id="modalWarehouse" class="modal-mask"><div class="modal"><div class="modal-head"><h3>ğŸ“¦ ä»“åº“</h3><span class="close-x" onclick="closeModal()">Ã—</span></div><div class="modal-body"><div class="list-grid" id="whList"></div></div><div class="modal-foot"><button class="act-btn" style="background:#aaa;width:100%" onclick="closeModal()">å…³é—­</button></div></div></div>
<div id="modalMarket" class="modal-mask"><div class="modal"><div class="modal-head"><h3>ğŸ¥¦ èœå¸‚åœº</h3><span class="close-x" onclick="closeModal()">Ã—</span></div><div class="modal-body"><p style="font-size:12px;color:#999;margin:0 0 10px">ä»·æ ¼æ³¢åŠ¨</p><div class="list-grid" id="marketList"></div></div><div class="modal-foot"><button class="act-btn" style="background:#aaa;width:100%" onclick="closeModal()">å®Œæˆ</button></div></div></div>
<div id="modalMenu" class="modal-mask"><div class="modal"><div class="modal-head"><h3 id="menuTitle">ğŸ“ ä»Šæ—¥èœå•</h3><span class="close-x" onclick="closeModal()">Ã—</span></div><div class="modal-body"><div class="list-grid" id="menuSelection"></div></div><div class="modal-foot"><button class="act-btn" style="background:var(--primary);width:100%" onclick="startBusiness()">ğŸš€ å¼€åº—</button></div></div></div>
<div id="modalReport" class="modal-mask"><div class="modal"><div class="modal-body" style="text-align:center"><div style="font-size:50px">ğŸ’°</div><h2>ä»Šæ—¥è¥æ”¶</h2><h1 style="color:var(--green)">+<span id="repMoney">0</span></h1></div><div class="modal-foot"><button class="act-btn" style="background:var(--primary);width:100%" onclick="nextDay()">ğŸ’¤ ä¼‘æ¯ (è‡ªåŠ¨ä¿å­˜)</button></div></div></div>

<div class="ach-toast" id="achToast">
    <div style="font-size:30px">ğŸ†</div>
    <div><b style="color:#f57f17">æˆå°±è§£é”!</b><div id="achName" style="font-size:12px;color:#666"></div></div>
</div>
<div id="toast" class="toast">æç¤º</div>

<script>
    // === æ•°æ®å®šä¹‰ ===
    const ITEMS = {
        rice:{n:'å¤§ç±³',i:'ğŸš',p:3}, egg:{n:'é¸¡è›‹',i:'ğŸ¥š',p:5}, tomato:{n:'ç•ªèŒ„',i:'ğŸ…',p:6},
        noodle:{n:'é¢æ¡',i:'ğŸœ',p:5}, veg:{n:'é’èœ',i:'ğŸ¥¬',p:5}, potato:{n:'åœŸè±†',i:'ğŸ¥”',p:5},
        meat:{n:'é²œè‚‰',i:'ğŸ¥©',p:18}, fish:{n:'é²œé±¼',i:'ğŸŸ',p:23}, bread:{n:'é¢åŒ…',i:'ğŸ',p:8},
        flour:{n:'é¢ç²‰',i:'ğŸ¥¡',p:6}, sugar:{n:'ç³–',i:'ğŸ¬',p:5}, milk:{n:'ç‰›å¥¶',i:'ğŸ¥›',p:8},
        chicken:{n:'é¸¡è‚‰',i:'ğŸ—',p:15}, tofu:{n:'è±†è…',i:'ğŸ§Š',p:6}, shrimp:{n:'è™¾ä»',i:'ğŸ¤',p:23},
        cheese:{n:'å¥¶é…ª',i:'ğŸ§€',p:12}
    };
    const RECIPES = [
        {id:'r1', n:'ç™½ç±³é¥­', req:['rice'], p:8, i:'ğŸš', lv:1},
        {id:'r2', n:'è·åŒ…è›‹', req:['egg'], p:12, i:'ğŸ³', lv:1},
        {id:'r3', n:'ç•ªèŒ„ç‚’è›‹', req:['egg','tomato'], p:30, i:'ğŸ¥˜', lv:1},
        {id:'r4', n:'æ¸…æ±¤é¢', req:['noodle'], p:18, i:'ğŸœ', lv:3},
        {id:'r5', n:'ç‚¸è–¯æ¡', req:['potato'], p:22, i:'ğŸŸ', lv:3},
        {id:'r6', n:'ä¸‰æ˜æ²»', req:['bread','egg'], p:35, i:'ğŸ¥ª', lv:5},
        {id:'r7', n:'è”¬èœæ²™æ‹‰', req:['veg','tomato'], p:28, i:'ğŸ¥—', lv:5},
        {id:'r8', n:'è›‹ç‚’é¥­', req:['rice','egg'], p:32, i:'ğŸ›', lv:7},
        {id:'r9', n:'è±†è…æ±¤', req:['tofu','veg'], p:30, i:'ğŸ²', lv:7},
        {id:'r10', n:'ç‰›å¥¶å¸ƒä¸', req:['milk','sugar'], p:40, i:'ğŸ®', lv:9},
        {id:'r11', n:'çº¢çƒ§è‚‰', req:['meat','sugar'], p:65, i:'ğŸ–', lv:9},
        {id:'r12', n:'ç‚¸é¸¡', req:['chicken','flour'], p:60, i:'ğŸ—', lv:11},
        {id:'r13', n:'ç‰›è‚‰é¢', req:['noodle','meat'], p:70, i:'ğŸ', lv:11},
        {id:'r14', n:'é²œè™¾æ„é¢', req:['noodle','shrimp'], p:85, i:'ğŸ¤', lv:13},
        {id:'r15', n:'éº»å©†è±†è…', req:['tofu','meat'], p:75, i:'ğŸ¥˜', lv:13},
        {id:'r16', n:'èŠå£«è›‹ç³•', req:['flour','cheese','sugar'], p:90, i:'ğŸ°', lv:15},
        {id:'r17', n:'æŠ«è¨', req:['flour','cheese','tomato'], p:95, i:'ğŸ•', lv:17},
        {id:'r18', n:'ç‚¸é±¼è–¯æ¡', req:['fish','potato'], p:80, i:'ğŸ±', lv:19},
        {id:'r19', n:'ç”œç”œåœˆ', req:['flour','sugar'], p:50, i:'ğŸ©', lv:21},
        {id:'r20', n:'æµ·é²œå¤§é¤', req:['fish','shrimp'], p:120, i:'ğŸ¦', lv:25}
    ];
    const FACILITIES = [
        {lv:1, name:'ç®€é™‹æ‘Šä½', mult:1.0, cost:0, reqLv:1},
        {lv:2, name:'æ¸©é¦¨å°åº—', mult:1.1, cost:500, reqLv:5},
        {lv:3, name:'ç²¾è‡´é¤é¦†', mult:1.2, cost:1000, reqLv:10},
        {lv:4, name:'è±ªåé¤å…', mult:1.3, cost:1500, reqLv:15},
        {lv:5, name:'æ˜Ÿçº§åœ°æ ‡', mult:1.4, cost:2500, reqLv:20},
        {lv:6, name:'ç¾é£Ÿæ®¿å ‚', mult:1.5, cost:5000, reqLv:30}
    ];
    const ACHIEVEMENTS = [
        {id:'first', n:'ç¬¬ä¸€æ¡¶é‡‘', desc:'ç¬¬ä¸€æ¬¡è·å¾—é‡‘å¸', i:'ğŸª™', check:g=>g.totalEarned>0},
        {id:'1k', n:'åˆæ¥ä¹åˆ°', desc:'èµšå–1000é‡‘å¸', i:'ğŸ¥‰', check:g=>g.totalEarned>=1000},
        {id:'5k', n:'å°å°åº—é•¿', desc:'èµšå–5000é‡‘å¸', i:'ğŸ¥ˆ', check:g=>g.totalEarned>=5000},
        {id:'1w', n:'ä¸‡å…ƒå¯Œç¿', desc:'èµšå–10000é‡‘å¸', i:'ğŸ¥‡', check:g=>g.totalEarned>=10000},
        {id:'10rec', n:'å°å°å¨å¸ˆ', desc:'è§£é”10ä¸ªé£Ÿè°±', i:'ğŸ“œ', check:g=>RECIPES.filter(r=>r.lv<=g.lv).length>=10},
        {id:'allrec', n:'ç±³å…¶æ—å¤§å¨', desc:'è§£é”å…¨éƒ¨é£Ÿè°±', i:'ğŸ‘‘', check:g=>RECIPES.filter(r=>r.lv<=g.lv).length>=RECIPES.length},
        {id:'fac2', n:'åº—é“ºç¿»æ–°', desc:'è®¾æ–½å‡çº§åˆ°2çº§', i:'ğŸ”¨', check:g=>g.facLv>=2},
        {id:'fac6', n:'äº”æ˜Ÿé¤å…', desc:'è®¾æ–½å‡çº§åˆ°æ»¡çº§', i:'ğŸ°', check:g=>g.facLv>=6}
    ];

    // åˆå§‹ 200 é‡‘å¸
    let G = { money: 200, totalEarned: 0, day: 1, lv: 1, facLv: 1, inv: {}, prices: {}, menu: [], trend: null, potsUnlocked: 2, pots: [], seats: [null, null], queue: 0, selPot: -1, stats: {earn:0}, achieved: [], isPlaying: false };

    function loadGame() {
        // æ›´æ¢keyå¼ºåˆ¶åˆ·æ–°
        const save = localStorage.getItem('happyKitchen_Final_V3.1');
        if(save) {
            try {
                const data = JSON.parse(save);
                G = {...G, ...data};
                if(G.trend) G.trend = RECIPES.find(r=>r.id===G.trend.id) || RECIPES[0];
            } catch(e){}
        } else {
            for(let k in ITEMS) G.inv[k] = 3;
        }
    }
    function saveGame() { localStorage.setItem('happyKitchen_Final_V3.1', JSON.stringify(G)); }
    function manualSave() { saveGame(); toast('âœ… å­˜æ¡£æˆåŠŸ'); }
    function resetGame() { if(confirm('ç¡®å®šè¦åˆ é™¤å­˜æ¡£é‡æ¥å—ï¼Ÿ(åˆå§‹é‡‘å¸å°†é‡ç½®ä¸º200)')){ localStorage.removeItem('happyKitchen_Final_V3.1'); location.reload(); } }

    function init() {
        loadGame();
        for(let k in ITEMS) G.prices[k] = Math.ceil(ITEMS[k].p * (0.9 + Math.random()*0.3));
        if(!G.trend) {
            let u = RECIPES.filter(r=>r.lv<=G.lv);
            G.trend = u[Math.floor(Math.random()*u.length)] || RECIPES[0];
        }
        updateUI(); checkAch();
        G.pots=[]; for(let i=0; i<G.potsUnlocked; i++) G.pots.push({items:[], status:'idle', res:null});
        renderScene();
    }
    function updateUI() {
        document.getElementById('uiMoney').innerText=G.money;
        document.getElementById('uiDay').innerText=G.day;
        document.getElementById('uiLv').innerText=G.lv;
        document.getElementById('trendIcon').innerText=G.trend.i;
        let fac = FACILITIES[G.facLv-1];
        document.getElementById('uiFacName').innerText = `ğŸ  ${fac.name} (${Math.round(fac.mult*100)}%)`;
    }

    function renderScene() {
        const pBox=document.getElementById('potBox'); pBox.innerHTML='';
        G.pots.forEach((p,i)=>{
            let c=''; if(p.status==='idle')c=p.items.map(k=>ITEMS[k].i).join(''); else if(p.status==='done')c=p.res.i;
            let d=document.createElement('div'); d.className='stove-slot';
            d.innerHTML=`
                <div class="burner"></div>
                <div class="pot ${G.selPot===i?'selected':''} ${p.status} ${c?'has-food':''}" onclick="selPot(${i},event)">
                    <div class="pot-ear l"></div><div class="pot-ear r"></div>
                    <div class="steam">â™¨ï¸</div>
                    <div class="pot-lid"><div class="lid-knob"></div></div>
                    <div class="pot-body"></div>
                    <div class="pot-icon">${c}</div>
                </div>`;
            pBox.appendChild(d);
        });
        const pAct=document.getElementById('potAct');
        if(G.selPot!==-1 && ((G.pots[G.selPot].status==='idle' && G.pots[G.selPot].items.length>0) || G.pots[G.selPot].status==='done')) {
            pAct.classList.add('show');
        } else pAct.classList.remove('show');

        const sBox=document.getElementById('seatBox'); sBox.innerHTML='';
        for(let i=0; i<2; i++) {
            let c=G.seats[i]; let d=document.createElement('div'); d.className='seat';
            if(c) d.innerHTML=`<div class="cust show" onclick="serve(${i})"><div class="bubble">${c.dish.i}</div><div class="cust-face">${c.face}</div></div>`;
            sBox.appendChild(d);
        }

        if(G.isPlaying) {
            const gNav=document.getElementById('gameNav'); gNav.innerHTML='';
            for(let k in ITEMS) {
                let d=document.createElement('div'); d.className='ing-card';
                d.innerHTML=`<div style="font-size:24px">${ITEMS[k].i}</div><div class="ing-qty">${G.inv[k]}</div>`;
                d.onclick=()=>addIng(k); gNav.appendChild(d);
            }
        }
    }

    function selPot(i,e) { e.stopPropagation(); if(G.pots[i].status!=='cooking'){G.selPot=G.selPot===i?-1:i; renderScene();} }
    function addIng(k) { if(G.inv[k]<=0)return toast('æ²¡åº“å­˜'); if(G.selPot===-1)return toast('è¯·é€‰é”…'); let p=G.pots[G.selPot]; if(p.status!=='idle')return toast('é”…æ­£å¿™'); G.inv[k]--; p.items.push(k); renderScene(); }
    function clearPot() { G.pots[G.selPot]={items:[],status:'idle',res:null}; renderScene(); }
    function cook() {
        let p=G.pots[G.selPot]; p.status='cooking'; renderScene();
        setTimeout(()=>{
            let m=p.items.sort().join(','); let f=RECIPES.find(r=>r.req.slice().sort().join(',')===m);
            p.status='done'; p.res=f||{n:'é»‘æš—æ–™ç†',p:0,i:'ğŸ¤¢'}; renderScene();
        },1500);
    }
    function serve(i) {
        let p=G.pots[G.selPot]; let c=G.seats[i];
        if(!p||p.status!=='done')return toast('æ²¡å¥½'); if(!c)return;
        if(c.dish.n===p.res.n) {
            let facM=FACILITIES[G.facLv-1].mult; let trM=p.res.id===G.trend.id?2:1;
            let earn=Math.floor(p.res.p*facM*trM);
            G.money+=earn; G.totalEarned+=earn; G.stats.earn+=earn; G.seats[i]=null; G.pots[G.selPot]={items:[],status:'idle',res:null}; G.selPot=-1;
            if(G.money>G.lv*600){G.lv++;toast('åº—é“ºå‡çº§!'); checkAch();}
            updateUI(); checkAch(); renderScene(); toast(`+$${earn}`);
        } else toast('ä¸è¦');
    }

    let loopId;
    function startBusiness() {
        if(G.menu.length<1)return toast('è¯·è‡³å°‘é€‰1é“èœ');
        closeModal(); G.isPlaying=true; G.queue=5+G.lv; G.seats=[null,null]; G.selPot=-1; G.stats={earn:0};
        G.pots=[]; for(let i=0; i<G.potsUnlocked; i++) G.pots.push({items:[], status:'idle', res:null});
        document.getElementById('homeNav').style.display='none'; document.getElementById('gameNav').style.display='flex'; document.getElementById('endBtn').style.display='block';
        renderScene(); spawn(0);
        if(loopId) clearInterval(loopId); loopId=setInterval(loop,800);
    }
    function loop() {
        if(!G.isPlaying)return;
        let e=G.seats.indexOf(null); if(e!==-1 && G.queue>0 && Math.random()>0.4){spawn(e); G.queue--;}
        if(G.queue===0 && !G.seats[0] && !G.seats[1]) setTimeout(endDay,1000);
    }
    function spawn(i) {
        if(G.seats[i])return;
        let d=G.menu[Math.floor(Math.random()*G.menu.length)];
        if(G.menu.includes(G.trend) && Math.random()<0.3) d=G.trend;
        G.seats[i]={dish:d, face:['ğŸ‘±','ğŸ‘µ','ğŸ‘¨','ğŸ§’'][Math.floor(Math.random()*4)]};
        renderScene();
    }
    function endDay() { clearInterval(loopId); G.isPlaying=false; saveGame(); document.getElementById('modalReport').style.display='flex'; document.getElementById('repMoney').innerText=G.stats.earn; }
    function nextDay() { G.day++; saveGame(); closeModal(); document.getElementById('homeNav').style.display='grid'; document.getElementById('gameNav').style.display='none'; document.getElementById('endBtn').style.display='none'; init(); }

    // å¼¹çª—é€»è¾‘
    function openAchieve() {
        const el = document.getElementById('achList'); el.innerHTML = '';
        ACHIEVEMENTS.forEach(a => {
            const unlocked = G.achieved.includes(a.id);
            const d = document.createElement('div');
            d.className = `ach-item ${unlocked ? 'unlocked' : ''}`;
            d.innerHTML = `<div class="ach-icon">${a.i}</div><div class="ach-info"><h4>${a.n}</h4><p>${a.desc}</p></div><div style="font-size:20px">${unlocked ? 'âœ…' : 'ğŸ”’'}</div>`;
            el.appendChild(d);
        });
        document.getElementById('modalAchieve').style.display = 'flex';
    }

    function openMarket() {
        const el = document.getElementById('marketList'); el.innerHTML = '';
        Object.keys(ITEMS).forEach(k => {
            const item = ITEMS[k];
            const d = document.createElement('div');
            d.className = 'grid-item';
            d.innerHTML = `<div style="font-size:24px">${item.i}</div><div>${item.n}</div><div style="color:orange">$${G.prices[k]}</div><div class="stock-tag">å½“å‰:${G.inv[k]}</div>`;
            d.onclick = () => {
                if(G.money >= G.prices[k]) { G.money -= G.prices[k]; G.inv[k]++; updateUI(); openMarket(); } else { toast('æ²¡é’±'); }
            };
            el.appendChild(d);
        });
        document.getElementById('modalMarket').style.display = 'flex';
    }

    function openRecipes() {
        const el = document.getElementById('recipeList'); el.innerHTML = '';
        RECIPES.forEach(r => {
            const locked = G.lv < r.lv;
            const d = document.createElement('div');
            d.className = 'recipe-row';
            if(locked) d.style.opacity = '0.5';
            const reqStr = r.req.map(k => ITEMS[k].i).join('+');
            d.innerHTML = `<div style="font-size:24px">${locked ? 'ğŸ”’' : r.i}</div>
                           <div class="recipe-info"><div style="font-weight:bold">${locked ? '???' : r.n}</div><div style="font-size:12px;color:#888">${locked ? `Lv.${r.lv}è§£é”` : `é…æ–¹:${reqStr}`}</div></div>
                           <div style="font-weight:bold;color:orange">$${r.p}</div>`;
            el.appendChild(d);
        });
        document.getElementById('modalRecipes').style.display = 'flex';
    }

    function openUpgrade() {
        const el = document.getElementById('facList'); el.innerHTML = '';
        FACILITIES.forEach(f => {
            const d = document.createElement('div');
            const isCur = G.facLv === f.lv;
            const isOwned = G.facLv > f.lv;
            const isLocked = G.lv < f.reqLv;
            d.className = `fac-item ${isCur ? 'current' : ''}`;
            let btnHtml = isCur ? '<small style="color:green">å½“å‰</small>' : (isOwned ? '<small style="color:#999">å·²æ‹¥æœ‰</small>' : (isLocked ? `<small style="color:#999">Lv.${f.reqLv}è§£é”</small>` : `<button class="up-btn" onclick="buyFac(${f.lv})">å‡çº§ $${f.cost}</button>`));
            d.innerHTML = `<div><b>${f.name}</b><br><small style="color:#888">åŠ æˆ ${Math.round(f.mult*100)}%</small></div>${btnHtml}`;
            el.appendChild(d);
        });
        document.getElementById('modalUpgrade').style.display = 'flex';
    }

    function openMenu() {
        document.getElementById('menuTitle').innerText = `ğŸ“ ä»Šæ—¥èœå• (${G.menu.length}/5)`;
        const el = document.getElementById('menuSelection'); el.innerHTML = '';
        RECIPES.filter(r => r.lv <= G.lv).forEach(r => {
            const d = document.createElement('div');
            d.className = `grid-item ${G.menu.includes(r) ? 'sel' : ''}`;
            d.innerHTML = `<div style="font-size:24px">${r.i}</div><div>${r.n}</div>${r.id===G.trend.id ? '<span style="color:red;font-size:10px">ğŸ”¥</span>' : ''}`;
            d.onclick = () => {
                if(G.menu.includes(r)) G.menu = G.menu.filter(x => x !== r);
                else { if(G.menu.length >= 5) return toast('æœ€å¤š5é“'); G.menu.push(r); }
                openMenu();
            };
            el.appendChild(d);
        });
        document.getElementById('modalMenu').style.display = 'flex';
    }

    function openWarehouse() {
        const el = document.getElementById('whList'); el.innerHTML = '';
        Object.keys(ITEMS).forEach(k => {
            const item = ITEMS[k];
            const d = document.createElement('div');
            d.className = 'grid-item';
            d.innerHTML = `<div style="font-size:24px">${item.i}</div><small>${item.n} x${G.inv[k]}</small>`;
            el.appendChild(d);
        });
        document.getElementById('modalWarehouse').style.display = 'flex';
    }

    function buyFac(lv) {
        const f = FACILITIES.find(x => x.lv === lv);
        if(G.money >= f.cost) { G.money -= f.cost; G.facLv = lv; updateUI(); saveGame(); openUpgrade(); toast('è£…ä¿®æˆåŠŸ'); } else toast('é’±ä¸å¤Ÿ');
    }

    function checkAch() {
        let updated = false;
        ACHIEVEMENTS.forEach(a => {
            if(!G.achieved.includes(a.id) && a.check(G)) {
                G.achieved.push(a.id);
                document.getElementById('achName').innerText = a.n;
                document.getElementById('achToast').classList.add('show');
                setTimeout(() => document.getElementById('achToast').classList.remove('show'), 3000);
                updated = true;
            }
        });
        if(updated) saveGame();
    }

    function closeModal() { document.querySelectorAll('.modal-mask').forEach(e => e.style.display = 'none'); }
    function toast(m) { let t=document.getElementById('toast'); t.innerText=m; t.style.opacity=1; setTimeout(()=>t.style.opacity=0,1000); }

    init();
</script>
</body>
</html>
