<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ğŸ’– çˆ±çš„å¨æˆ¿ - ä¿®å¤ç‰ˆ</title>
    <style>
        :root {
            --bg: #fff3e0;
            --primary: #ff7043;
            --green: #66bb6a;
            --text: #3e2723;
            --pot-body: #80cbc4;
            --pot-stroke: #00695c;
        }

        body {
            margin: 0; padding: 0; font-family: 'YouYuan', 'Microsoft YaHei', sans-serif;
            background: var(--bg); color: var(--text); 
            height: 100vh; height: 100dvh; 
            overflow: hidden;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        .app { display: flex; flex-direction: column; height: 100%; max-width: 500px; margin: 0 auto; background: #fff8e1; position: relative; }

        /* === é¡¶éƒ¨ === */
        .top-bar {
            padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(8px);
            border-bottom: 2px solid #ffe0b2; z-index: 20;
            flex-shrink: 0;
        }
        .badge {
            background: #fff; border: 2px solid #ffe0b2; padding: 2px 8px;
            border-radius: 20px; font-size: 12px; font-weight: bold;
            display: flex; align-items: center; gap: 4px; color: #5d4037;
        }
        .xp-track { width: 50px; height: 6px; background: #eee; border-radius: 4px; overflow: hidden; border: 1px solid #ddd; margin-top: 4px; }
        .xp-fill { height: 100%; background: #66bb6a; width: 0%; transition: width 0.5s; }

        /* === åœºæ™¯ === */
        .scene { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        
        .wall {
            height: 40%; position: relative; border-bottom: 12px solid #fff;
            background-color: #fff3e0;
            background-image: radial-gradient(#ffccbc 1px, transparent 1px);
            background-size: 24px 24px;
        }
        
        .title-float {
            position: absolute; top: 10%; width: 100%; text-align: center; pointer-events: none; z-index: 5;
            transition: 0.3s;
        }
        .title-float.hidden { opacity: 0; transform: translateY(-20px); }
        .main-title { font-size: 36px; color: #ff8a80; text-shadow: 2px 2px 0 #fff; margin: 0; font-weight: 900; letter-spacing: 2px; }
        .sub-title { background: #fff; color: #ffab91; padding: 2px 10px; border-radius: 15px; font-size: 10px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .window {
            position: absolute; left: 15px; top: 15px; width: 80px; height: 60px;
            background: linear-gradient(#81d4fa, #e1f5fe); border: 4px solid #fff; border-radius: 12px;
            box-shadow: 0 5px 0 #eee; overflow: hidden;
        }
        .cloud { position:absolute; top:10px; font-size:24px; opacity:0.9; animation: cloudMove 25s linear infinite; }
        @keyframes cloudMove { from{left:-40px;} to{left:100px;} }

        .board {
            position: absolute; right: 15px; top: 15px; width: 90px; height: 70px;
            background: #4e342e; border: 4px solid #8d6e63; border-radius: 8px;
            color: #fff; text-align: center; transform: rotate(-3deg); cursor: pointer;
            box-shadow: 0 5px 10px rgba(0,0,0,0.2); pointer-events: auto;
        }
        
        .floor {
            flex: 1; background: #fbe9e7; position: relative;
            background-image: repeating-linear-gradient(45deg, #fff 0, #fff 2px, transparent 3px, transparent 15px);
        }

        /* === æŸœå°ä¸é”… === */
        .counter {
            position: absolute; top: -50px; left: 2%; width: 96%; height: 90px;
            background: #d7ccc8; border-radius: 16px; border-bottom: 14px solid #8d6e63;
            display: flex; justify-content: space-around; align-items: flex-end;
            padding-bottom: 15px; z-index: 10; 
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }

        .stove-unit { 
            position: relative; width: 70px; height: 70px; 
            display: flex; justify-content: center; align-items: flex-end;
        }
        
        .burner {
            position: absolute; bottom: 0; width: 54px; height: 12px;
            background: #3e2723; border-radius: 50%; border: 2px solid #5d4037;
            z-index: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .pot { 
            width: 64px; height: 50px; position: relative; cursor: pointer; 
            z-index: 5; margin-bottom: 4px; transform-origin: bottom center;
            transition: transform 0.2s; pointer-events: auto;
        }
        .pot:active { transform: scale(0.9); }
        .pot.selected { transform: translateY(-10px) scale(1.1); filter: drop-shadow(0 10px 10px rgba(0,0,0,0.2)); }

        .pot-body {
            width: 100%; height: 100%; background: var(--pot-body);
            border-radius: 6px 6px 25px 25px; border: 3px solid var(--pot-stroke);
            position: relative; overflow: hidden;
        }
        .pot-lid {
            position: absolute; top: -8px; left: -5%; width: 110%; height: 16px;
            background: rgba(255,255,255,0.6); border-radius: 50%; 
            border: 3px solid var(--pot-stroke); z-index: 6;
        }
        .lid-knob {
            position: absolute; top: -6px; left: 50%; transform: translateX(-50%);
            width: 14px; height: 8px; background: #3e2723; border-radius: 4px;
            border-bottom: 2px solid rgba(0,0,0,0.3);
        }
        .pot-handle { position: absolute; top: 10px; width: 10px; height: 14px; background: var(--pot-stroke); border-radius: 4px; }
        .pot-handle.l { left: -7px; } .pot-handle.r { right: -7px; }
        
        .pot-icon {
            position: absolute; top: -35px; width: 100%; text-align: center;
            font-size: 24px; opacity: 0; transform: translateY(15px); transition: 0.3s;
            z-index: 7;
        }
        .pot.has-food .pot-icon { opacity: 1; transform: translateY(0); }
        .pot.cooking .pot-body { background: #ef5350; animation: cookBob 0.4s infinite alternate; }
        .pot.done .pot-body { background: #66bb6a; border-color: #fff; }

        .pot-locked {
            width: 50px; height: 40px; margin-bottom: 5px;
            background: rgba(0,0,0,0.05); border-radius: 15px;
            border: 2px dashed #bdbdbd; color: #9e9e9e;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 10px; cursor: pointer; pointer-events: auto;
        }

        .pot-hint {
            position: absolute; top: -55px; width: 100%; text-align: center;
            font-size: 12px; color: #ff9800; font-weight: bold;
            opacity: 0; pointer-events: none; transition: 0.3s;
            text-shadow: 1px 1px 0 #fff;
        }
        .pot-hint.show { opacity: 1; animation: hintBounce 0.5s infinite alternate; }
        @keyframes hintBounce { from{transform:translateY(0);} to{transform:translateY(-5px);} }

        /* åº§ä½ */
        .seat-row { 
            position: absolute; top: 130px; 
            width: 100%; display: flex; justify-content: center; gap: 4px;
            z-index: 20; pointer-events: none;
        }
        .seat-wrapper { width: 65px; height: 90px; position: relative; display: flex; justify-content: center; }
        .stool {
            width: 40px; height: 30px; background: #8d6e63; border-radius: 50%;
            border: 3px solid #5d4037; box-shadow: 0 4px 0 #3e2723;
            position: absolute; bottom: 15px; z-index: 1;
        }
        .stool-locked {
            width: 40px; height: 30px; background: rgba(0,0,0,0.1); border-radius: 50%;
            border: 2px dashed #aaa; position: absolute; bottom: 15px; z-index: 1;
            display: flex; align-items: center; justify-content: center; font-size: 10px; color: #888;
            cursor: pointer; pointer-events: auto; text-align: center; line-height: 1.1;
        }
        
        .cust {
            position: absolute; bottom: 40px; display: flex; flex-direction: column; align-items: center;
            opacity: 0; transition: 0.4s; z-index: 5; pointer-events: auto; cursor: pointer;
            transform: scale(0.5);
        }
        .cust.show { opacity: 1; transform: scale(1); }
        .cust-head { font-size: 40px; z-index: 2; }
        .cust-body { width: 36px; height: 26px; background: #90caf9; margin-top: -6px; border-radius: 12px 12px 4px 4px; z-index: 1; border: 2px solid rgba(0,0,0,0.1); }
        .bubble {
            background: #fff; border: 2px solid #4e342e; padding: 2px 6px;
            border-radius: 12px; font-size: 14px; font-weight: bold; margin-bottom: 2px;
            z-index: 30; animation: float 2s infinite; white-space: nowrap;
        }
        .bubble::after { content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); border-width: 6px 6px 0; border-style: solid; border-color: #4e342e transparent transparent; }

        .timer-track {
            position: absolute; top: -12px; left: 50%; transform: translateX(-50%);
            width: 36px; height: 4px; background: #eee; border: 1px solid #3e2723;
            border-radius: 4px; overflow: hidden; z-index: 40; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .timer-fill {
            height: 100%; background: #66bb6a; width: 100%;
            transition: width 0.05s linear, background 0.2s;
        }

        /* === åº•éƒ¨èœå• === */
        .controls {
            background: #fff; padding: 15px; z-index: 50;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.05); border-radius: 20px 20px 0 0;
            pointer-events: auto; display: flex; flex-direction: column; gap: 10px;
            flex-shrink: 0; padding-bottom: max(15px, env(safe-area-inset-bottom));
        }
        
        .home-menu-grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; 
        }
        
        .menu-btn {
            background: #f9f9f9; border: 1px solid #eee; border-radius: 12px;
            padding: 8px 0; text-align: center; cursor: pointer; transition: 0.1s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .menu-btn:active { transform: scale(0.95); background: #eee; }
        .btn-icon { font-size: 20px; margin-bottom: 2px; }
        .btn-txt { font-size: 11px; font-weight: bold; color: #666; }
        
        .start-btn-container {
            width: 100%; display: flex; justify-content: center; margin-top: 5px;
        }
        .start-btn {
            width: 100%; background: linear-gradient(to right, #ff7043, #ff8a65);
            color: white; border: none; padding: 14px; font-size: 16px;
            border-radius: 16px; box-shadow: 0 6px 15px rgba(255, 112, 67, 0.3);
            font-weight: 900; cursor: pointer; text-align: center;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .start-btn:active { transform: scale(0.98); }

        /* é…èœæ ä¼˜åŒ–ï¼šè‡ªåŠ¨æ¢è¡Œï¼Œä¸æ»‘åŠ¨ */
        .game-menu { 
            display: none; 
            flex-wrap: wrap; /* å…è®¸æ¢è¡Œ */
            justify-content: center; 
            gap: 6px; 
            padding-bottom: 5px; 
            overflow-y: auto; 
            max-height: 140px; 
        }
        .ing-card { 
            flex: 0 0 48px; height: 58px; /* ç´§å‡‘å°ºå¯¸ */
            background: #fff; border: 1px solid #ddd; border-radius: 8px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            cursor: pointer; position: relative; 
        }
        .ing-card:active { background: #f0f0f0; border-color: #ccc; transform: scale(0.95); }
        .ing-qty { font-size: 10px; color: #888; background: #eee; padding: 0 5px; border-radius: 8px; margin-top: 2px; }

        .pot-act { position: absolute; bottom: 150px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; pointer-events: none; opacity: 0; transition: 0.2s; z-index: 40; }
        .pot-act.show { opacity: 1; pointer-events: auto; }
        .act-btn { border: none; padding: 8px 20px; border-radius: 30px; color: white; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-size: 12px; }

        /* å¼¹çª—é€šç”¨ */
        .modal-mask { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal { background: #fff; width: 85%; max-width: 360px; max-height: 80vh; border-radius: 20px; display: flex; flex-direction: column; animation: pop 0.3s; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-head { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .modal-head h3 { margin: 0; font-size: 16px; }
        .modal-body { padding: 15px; overflow-y: auto; flex: 1; }
        .modal-foot { padding: 12px; border-top: 1px solid #f0f0f0; }
        .list-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .grid-item { border: 1px solid #eee; border-radius: 10px; padding: 8px; text-align: center; cursor: pointer; position: relative; transition:0.1s; }
        .grid-item.sel { background: #fff3e0; border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary); }

        @media (max-width: 450px), (max-height: 700px) {
            .wall { height: 35%; }
            .counter { top: -45px; height: 80px; }
            .seat-row { top: 110px; }
            .seat-wrapper { width: 60px; height: 85px; }
            .stool { width: 35px; height: 25px; }
            .stool-locked { width: 35px; height: 25px; font-size: 9px; }
            .cust { transform: scale(0.45); bottom: 35px; }
            .bubble { font-size: 12px; padding: 2px 4px; }
            .main-title { font-size: 32px; }
            .pot-act { bottom: 130px; }
        }

        @keyframes cookBob { 0%{transform:translateY(0);} 50%{transform:translateY(-2px);} 100%{transform:translateY(0);} }
        @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-4px);} }
        @keyframes pop { from{transform:scale(0.9);opacity:0;} to{transform:scale(1);opacity:1;} }

        .toast { 
            position: fixed; top: 30%; left: 50%; transform: translate(-50%); 
            background: rgba(255, 255, 255, 0.9); color: #bf360c; 
            padding: 5px 15px; border-radius: 20px; border: 2px solid #ff7043;
            opacity: 0; pointer-events: none; z-index: 500; transition: 0.3s; 
            font-size: 14px; font-weight: bold; text-align: center; width: auto; min-width: 80px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .end-btn { width: 100%; text-align: center; margin-top: 15px; font-size: 12px; color: #e53935; cursor: pointer; display: none; text-decoration: underline; }
        .close-x { font-size: 24px; cursor: pointer; color: #aaa; }
    </style>
</head>
<body>

<div class="app">
    <div class="top-bar">
        <div class="badge">ğŸ’° <span id="uiMoney">0</span></div>
        <div class="badge">ğŸ“… <span id="uiDay">1</span></div>
        <div class="badge">ğŸ‘¥ <span id="uiQueue">0</span></div>
        <div style="display:flex; flex-direction:column; align-items:flex-end;">
            <div style="font-size:12px; font-weight:bold; background:#5d4037; color:white; padding:2px 8px; border-radius:10px;">Lv.<span id="uiLv">1</span></div>
            <div class="xp-track"><div class="xp-fill" id="uiXp"></div></div>
        </div>
    </div>

    <div class="scene">
        <div class="title-float" id="homeTitle">
            <h1 class="main-title">çˆ±çš„å¨æˆ¿ï¼</h1>
            <span class="sub-title">Love & Cooking</span>
        </div>

        <div class="wall">
            <div class="window"><div class="cloud">â˜ï¸</div></div>
            <div class="board" onclick="toast('å¿…åƒæ¦œï¼šæ”¶ç›Šç¿»å€ï¼')">
                <div style="font-size:10px;color:#ffcc80">TODAY</div>
                <div style="font-size:30px" id="trendIcon">?</div>
                <div style="font-size:10px;background:#e53935;padding:0 5px;border-radius:4px;color:white">HOT</div>
            </div>
        </div>
        
        <div class="floor">
            <div class="counter"><div id="potBox" style="display:flex; width:100%; justify-content:space-around;"></div></div>
            
            <div class="pot-act" id="potAct">
                <button class="act-btn" style="background:#ef5350" onclick="clearPot()">ğŸ—‘ï¸</button>
                <button class="act-btn" style="background:#ff7043" onclick="cook()">ğŸ”¥ 2s</button>
            </div>

            <div class="seat-row" id="seatBox"></div>
        </div>
    </div>

    <div class="controls">
        <div id="homeNav">
            <div class="home-menu-grid">
                <div class="menu-btn" onclick="openMarket()"><span class="btn-icon">ğŸ¥¦</span><span class="btn-txt">é‡‡è´­</span></div>
                <div class="menu-btn" onclick="openWarehouse()"><span class="btn-icon">ğŸ“¦</span><span class="btn-txt">ä»“åº“</span></div>
                <div class="menu-btn" onclick="openRecipes()"><span class="btn-icon">ğŸ“–</span><span class="btn-txt">é£Ÿè°±</span></div>
                <div class="menu-btn" onclick="openUpgrade()"><span class="btn-icon">ğŸ—ï¸</span><span class="btn-txt">è£…ä¿®</span></div>
                <div class="menu-btn" onclick="openAchieve()"><span class="btn-icon">ğŸ†</span><span class="btn-txt">æˆå°±</span></div>
                <div class="menu-btn" style="background:#e8f5e9; border-color:#c8e6c9;" onclick="manualSave()"><span class="btn-icon">ğŸ’¾</span><span class="btn-txt" style="color:#2e7d32">ä¿å­˜</span></div>
            </div>
            
            <div class="start-btn-container">
                <button class="start-btn" onclick="checkAndOpenMenu()">
                    <span style="font-size:24px">ğŸ³</span> é€‰æ‹©èœå• & å¼€å§‹è¥ä¸š
                </button>
            </div>
            
            <div style="text-align:center; margin-top:10px;">
                <span style="font-size:10px; color:#ccc; cursor:pointer; text-decoration:underline;" onclick="resetGame()">âš ï¸ æ¸…é™¤å­˜æ¡£é‡å¼€</span>
            </div>
        </div>

        <div class="game-menu" id="gameNav"></div>
        <div style="display:none; text-align:center; margin-top:5px;" id="endBtn">
            <span style="font-size:12px; color:#e53935; cursor:pointer;" onclick="endDay()">ğŸ›‘ ç»“æŸè¥ä¸šç»“ç®—</span>
        </div>
    </div>
</div>

<!-- å¼¹çª— -->
<div id="modalMenu" class="modal-mask"><div class="modal"><div class="modal-head"><h3 id="menuTitle">ğŸ“ ä»Šæ—¥èœå•</h3><span class="close-x" onclick="closeModal()">Ã—</span></div><div class="modal-body"><div class="list-grid" id="menuSelection"></div></div><div class="modal-foot"><button class="act-btn" style="background:var(--primary);width:100%" onclick="startBusiness()">ğŸš€ å¼€åº—</button></div></div></div>
<div id="modalCommon" class="modal-mask"><div class="modal"><div class="modal-head"><h3 id="commTitle"></h3><span class="close-x" onclick="closeModal()">Ã—</span></div><div class="modal-body" id="commBody"></div><div class="modal-foot"><button class="act-btn" style="background:#aaa;width:100%" onclick="closeModal()">å…³é—­</button></div></div></div>
<div id="modalReport" class="modal-mask"><div class="modal"><div class="modal-body" style="text-align:center"><div style="font-size:50px">ğŸ’°</div><h2>è¥æ”¶</h2><h1 style="color:green">+<span id="repMoney">0</span></h1><div id="repPenalty" style="color:#e53935;font-size:12px;margin-top:5px"></div></div><div class="modal-foot"><button class="act-btn" style="background:var(--primary);width:100%" onclick="nextDay()">ğŸ’¤ ä¼‘æ¯</button></div></div></div>
<div id="modalGameOver" class="modal-mask" style="z-index:200;"><div class="modal" style="width:280px;height:auto;"><div class="modal-body" style="text-align:center;padding-top:20px;"><div style="font-size:50px;margin-bottom:10px">ğŸš«</div><div style="font-weight:bold;color:#e53935">é£Ÿæä¸è¶³ï¼</div><div id="gameOverMsg" style="font-size:12px;color:#666;margin-top:5px"></div></div><div class="modal-foot"><button class="act-btn" style="background:var(--primary);width:100%" onclick="closeGameOver()">çŸ¥é“äº†ï¼Œç»“ç®—</button></div></div></div>

<div id="toast" class="toast">æç¤º</div>

<script>
    const ITEMS={rice:{n:'å¤§ç±³',i:'ğŸš',p:3},egg:{n:'é¸¡è›‹',i:'ğŸ¥š',p:5},tomato:{n:'ç•ªèŒ„',i:'ğŸ…',p:6},noodle:{n:'é¢æ¡',i:'ğŸœ',p:5},veg:{n:'é’èœ',i:'ğŸ¥¬',p:5},potato:{n:'åœŸè±†',i:'ğŸ¥”',p:5},meat:{n:'é²œè‚‰',i:'ğŸ¥©',p:18},fish:{n:'é²œé±¼',i:'ğŸŸ',p:23},bread:{n:'é¢åŒ…',i:'ğŸ',p:8},flour:{n:'é¢ç²‰',i:'ğŸ¥¡',p:6},sugar:{n:'ç³–',i:'ğŸ¬',p:5},milk:{n:'ç‰›å¥¶',i:'ğŸ¥›',p:8},chicken:{n:'é¸¡è‚‰',i:'ğŸ—',p:15},tofu:{n:'è±†è…',i:'â—»ï¸',p:6},shrimp:{n:'è™¾ä»',i:'ğŸ¤',p:23},cheese:{n:'å¥¶é…ª',i:'ğŸ§€',p:12}};
    const RECIPES=[
        {id:'r1',n:'ç™½ç±³é¥­',req:['rice'],p:7,i:'ğŸš',lv:1},
        {id:'r2',n:'è·åŒ…è›‹',req:['egg'],p:10,i:'ğŸ³',lv:1},
        {id:'r3',n:'ç•ªèŒ„ç‚’è›‹',req:['egg','tomato'],p:26,i:'ğŸ²',lv:1},
        {id:'r4',n:'æ¸…æ±¤é¢',req:['noodle'],p:15,i:'ğŸœ',lv:3},
        {id:'r5',n:'ç‚¸è–¯æ¡',req:['potato'],p:18,i:'ğŸŸ',lv:3},
        {id:'r6',n:'ä¸‰æ˜æ²»',req:['bread','egg'],p:30,i:'ğŸ¥ª',lv:5},
        {id:'r7',n:'è”¬èœæ²™æ‹‰',req:['veg','tomato'],p:24,i:'ğŸ¥—',lv:5},
        {id:'r8',n:'è›‹ç‚’é¥­',req:['rice','egg'],p:27,i:'ğŸ›',lv:7},
        {id:'r9',n:'è±†è…æ±¤',req:['tofu','veg'],p:26,i:'ğŸ²',lv:7},
        {id:'r10',n:'ç‰›å¥¶å¸ƒä¸',req:['milk','sugar'],p:32,i:'ğŸ®',lv:9},
        {id:'r11',n:'çº¢çƒ§è‚‰',req:['meat','sugar'],p:55,i:'ğŸ–',lv:9},
        {id:'r12',n:'ç‚¸é¸¡',req:['chicken','flour'],p:51,i:'ğŸ—',lv:11},
        {id:'r13',n:'ç‰›è‚‰é¢',req:['noodle','meat'],p:60,i:'ğŸ',lv:11},
        {id:'r14',n:'é²œè™¾æ„é¢',req:['noodle','shrimp'],p:70,i:'ğŸ¤',lv:13},
        {id:'r15',n:'éº»å©†è±†è…',req:['tofu','meat'],p:64,i:'ğŸ¥˜',lv:13},
        {id:'r16',n:'èŠå£«è›‹ç³•',req:['flour','cheese','sugar'],p:75,i:'ğŸ°',lv:15},
        {id:'r17',n:'æŠ«è¨',req:['flour','cheese','tomato'],p:81,i:'ğŸ•',lv:17},
        {id:'r18',n:'ç‚¸é±¼è–¯æ¡',req:['fish','potato'],p:68,i:'ğŸ±',lv:19},
        {id:'r19',n:'ç”œç”œåœˆ',req:['flour','sugar'],p:40,i:'ğŸ©',lv:21},
        {id:'r20',n:'æµ·é²œå¤§é¤',req:['fish','shrimp'],p:102,i:'ğŸ¦',lv:25}
    ];
    const FACILITIES=[{lv:1,name:'ç®€é™‹',mult:1.0,cost:0,req:1},{lv:2,name:'æ¸©é¦¨',mult:1.1,cost:500,req:5},{lv:3,name:'ç²¾è‡´',mult:1.2,cost:1000,req:10},{lv:4,name:'è±ªå',mult:1.3,cost:1500,req:15},{lv:5,name:'æ˜Ÿçº§',mult:1.4,cost:2500,req:20},{lv:6,name:'æ®¿å ‚',mult:1.5,cost:5000,req:30}];
    const ACHIEVEMENTS=[
        {id:'1',n:'ç¬¬ä¸€æ¡¶é‡‘',d:'è·åˆ©',i:'ğŸ’°',c:g=>g.totalEarned>0},
        {id:'2',n:'åƒå…ƒæˆ·',d:'èµš1000',i:'ğŸ’´',c:g=>g.totalEarned>=1000},
        {id:'3',n:'ä¸‡å…ƒæˆ·',d:'èµš10000',i:'ğŸ’',c:g=>g.totalEarned>=10000},
        {id:'4',n:'å°æœ‰åæ°”',d:'Lv10',i:'ğŸ…',c:g=>g.lv>=10},
        {id:'5',n:'é£ç”Ÿæ°´èµ·',d:'Lv20',i:'ğŸ',c:g=>g.lv>=20},
        {id:'6',n:'èµ„æ·±è€æ‰‹',d:'Lv30',i:'ğŸ–ï¸',c:g=>g.lv>=30},
        {id:'7',n:'ç±³å…¶æ—å¤§å¨',d:'Lv50',i:'ğŸ‘¨â€ğŸ³',c:g=>g.lv>=50},
        {id:'8',n:'å¤©å¤–æ¥å®¢',d:'æœåŠ¡å¤–æ˜Ÿäºº',i:'ğŸ‘½',c:g=>g.stats.aliensServed>0},
        {id:'9',n:'ç¾é£Ÿå¤§æ¯”æ‹¼',d:'æœåŠ¡ç¾é£Ÿå®¶',i:'ğŸ§',c:g=>g.stats.criticsServed>0},
        {id:'10',n:'è°åé”…é‡Œäº†',d:'åšé»‘æš—æ–™ç†',i:'ğŸ¤¢',c:g=>g.stats.vomitMade>0},
        {id:'11',n:'ç•™ä¸ä½äºº',d:'æ°”èµ°10äºº',i:'ğŸƒ',c:g=>g.stats.angryLeaves>=10}
    ];

    let G={money:200,totalEarned:0,day:1,lv:1,xp:0,facLv:1,inv:{},prices:{},menu:[],trend:null,potsUnlocked:1,seatsUnlocked:2,pots:[],seats:[null,null,null,null],queue:0,selPot:-1,stats:{earn:0, penalty:0, aliensServed:0, criticsServed:0, vomitMade:0, angryLeaves:0},achieved:[],isPlaying:false, dailyEvents:{}, dailyFlags:{}, activeIngredients: new Set(), prevPrices:{}};

    function loadGame(){ 
        const s=localStorage.getItem('HK_V34_Exp'); 
        if(s){
            try{
                const d=JSON.parse(s);
                G={...G,...d};
                if(G.trend)G.trend=RECIPES.find(r=>r.id===G.trend.id)||RECIPES[0];
                if(typeof G.seatsUnlocked === 'undefined') G.seatsUnlocked = 2;
                while(G.seats.length < 4) G.seats.push(null);
                if(!G.stats) G.stats={earn:0, penalty:0, aliensServed:0, criticsServed:0, vomitMade:0, angryLeaves:0};
            }catch(e){}
        }else{
            for(let k in ITEMS)G.inv[k]=3;
        } 
        if(!G.pots || G.pots.length < 2) { 
            G.pots=[]; for(let i=0;i<2;i++) G.pots.push({items:[],status:i<G.potsUnlocked?'idle':'locked',res:null}); 
        } 
    }
    function saveGame(){ localStorage.setItem('HK_V34_Exp',JSON.stringify(G)); }
    function manualSave(){ saveGame(); toast('âœ… å­˜æ¡£æˆåŠŸ'); }
    function resetGame(){ if(confirm('ç¡®å®šé‡ç½®ï¼Ÿ')){localStorage.removeItem('HK_V34_Exp');location.reload();} }

    function init(){ 
        loadGame(); 
        if(Object.keys(G.prevPrices).length === 0) {
            for(let k in ITEMS) G.prevPrices[k] = ITEMS[k].p;
        }
        randomizePrices();

        if(!G.trend){let u=RECIPES.filter(r=>r.lv<=G.lv);G.trend=u[Math.floor(Math.random()*u.length)]||RECIPES[0];} 
        
        let base = 6;
        let bonus = Math.round(G.lv * 1.5);
        G.queue = Math.min(50, base + bonus);

        updateUI(); 
        try { checkAch(); } catch(e) { console.error(e); } 
        G.seats=[null,null,null,null]; 
        renderScene(); 
    }

    function randomizePrices() {
        if(Object.keys(G.prices).length === 0) {
             for(let k in ITEMS) {
                let base = ITEMS[k].p;
                let factor = 0.85 + Math.random() * 0.35; // 0.85 ~ 1.20
                G.prices[k] = Math.ceil(base * factor);
            }
        }
    }

    function updateUI(){ 
        document.getElementById('uiMoney').innerText=G.money; document.getElementById('uiDay').innerText=G.day; document.getElementById('uiLv').innerText=G.lv; document.getElementById('trendIcon').innerText=G.trend.i; 
        document.getElementById('uiQueue').innerText=G.queue;
        let pct = Math.min(100, (G.xp/100)*100); document.getElementById('uiXp').style.width=pct+'%';
    }

    function renderScene(){
        const pBox=document.getElementById('potBox'); pBox.innerHTML='';
        G.pots.forEach((p,i)=>{
            let d=document.createElement('div'); d.className='stove-unit';
            if(p.status==='locked') {
                d.innerHTML=`<div class="burner"></div><div class="pot-locked" onclick="unlockPot()">ğŸ”’<div style="margin-top:2px">Lv.10+<br>$1000</div></div>`;
            } else {
                let c=''; if(p.status==='idle')c=p.items.map(k=>ITEMS[k].i).join(''); else if(p.status==='done')c=p.res.i;
                d.innerHTML=`
                <div class="burner"></div>
                <div class="pot-hint">è¯·é€‰æ‹©æˆ‘</div>
                <div class="pot ${G.selPot===i?'selected':''} ${p.status} ${c?'has-food':''}" onclick="selPot(${i},event)">
                    <div class="pot-handle l"></div><div class="pot-handle r"></div>
                    <div class="pot-lid"><div class="lid-knob"></div></div>
                    <div class="pot-body"></div>
                    <div class="pot-icon">${c}</div>
                </div>`;
            }
            pBox.appendChild(d);
        });
        
        const pAct=document.getElementById('potAct'); 
        if(G.selPot!==-1 && G.pots[G.selPot].status!=='locked'){
            let p=G.pots[G.selPot]; 
            if((p.status==='idle'&&p.items.length>0)||p.status==='done') pAct.classList.add('show'); else pAct.classList.remove('show');
        } else pAct.classList.remove('show');

        const sBox=document.getElementById('seatBox'); sBox.innerHTML='';
        const SHIRTS=['#90caf9','#a5d6a7','#ce93d8','#ffcc80'];
        
        for(let i=0; i<4; i++){
            let d=document.createElement('div'); d.className='seat-wrapper';
            
            if(i < G.seatsUnlocked) {
                d.innerHTML = '<div class="stool"></div>';
                let c = G.seats[i];
                if(c) {
                    d.innerHTML += `
                    <div class="cust show" onclick="serve(${i})">
                        <div class="timer-track"><div class="timer-fill" id="timer-${i}"></div></div>
                        <div class="bubble">${c.dish.i}</div>
                        <div class="cust-body-group">
                            <div class="cust-head">${c.face}</div>
                            <div class="cust-torso" style="background:${c.shirt}"><div class="cust-collar"></div></div>
                        </div>
                    </div>`;
                }
            } else if (i === G.seatsUnlocked) {
                let cost = i===2 ? 500 : 1000;
                let reqLv = i===2 ? 10 : 20;
                d.innerHTML = `<div class="stool-locked" onclick="unlockSeat(${i}, ${cost}, ${reqLv})">ğŸ”’<br>Lv${reqLv}<br>$${cost}</div>`;
            } else {
                d.innerHTML = ''; 
            }
            sBox.appendChild(d);
        }

        if(G.isPlaying){
            const gNav=document.getElementById('gameNav'); gNav.innerHTML='';
            for(let k in ITEMS){
                if(G.activeIngredients.has(k)) {
                    let d=document.createElement('div'); d.className='ing-card'; d.innerHTML=`<div style="font-size:22px">${ITEMS[k].i}</div><div class="ing-qty">${G.inv[k]}</div>`;
                    d.onclick=()=>addIng(k); gNav.appendChild(d);
                }
            }
        }
    }

    function unlockPot() { if(G.lv<10)return toast('éœ€Lv.10'); if(G.money<1000)return toast('éœ€$1000'); if(confirm('è§£é”?')){G.money-=1000;G.potsUnlocked=2;G.pots[1].status='idle';updateUI();renderScene();saveGame();toast('è§£é”æˆåŠŸ!');} }
    
    function unlockSeat(idx, cost, reqLv) {
        if(G.lv < reqLv) return toast(`éœ€ Lv.${reqLv}`);
        if(G.money < cost) return toast(`éœ€ $${cost}`);
        if(confirm(`èŠ±è´¹ $${cost} è§£é”æ–°åº§ä½?`)) {
            G.money -= cost;
            G.seatsUnlocked++;
            updateUI();
            renderScene();
            saveGame();
            toast('åº§ä½å·²æ‰©å»º! ğŸª‘');
        }
    }

    function selPot(i,e){e.stopPropagation();if(G.pots[i].status!=='cooking'){G.selPot=G.selPot===i?-1:i;renderScene();}}
    function addIng(k){
        if(G.inv[k]<=0)return toast('æ²¡åº“å­˜');
        if(G.selPot===-1){
            document.querySelectorAll('.pot-hint').forEach(el => {
                el.classList.add('show');
                setTimeout(() => el.classList.remove('show'), 1000);
            });
            return;
        }
        let p=G.pots[G.selPot];
        if(p.status!=='idle')return toast('é”…å¿™');
        G.inv[k]--;p.items.push(k);renderScene();
    }
    function clearPot(){G.pots[G.selPot]={items:[],status:'idle',res:null};renderScene();}
    function cook(){ 
        let p=G.pots[G.selPot]; 
        p.status='cooking'; 
        renderScene(); 
        setTimeout(()=>{ 
            let m=p.items.sort().join(','); 
            let f=RECIPES.find(r=>r.req.slice().sort().join(',')===m); 
            p.status='done'; 
            if(f) {
                p.res=f;
            } else {
                p.res={n:'é»‘æš—æ–™ç†',p:0,i:'ğŸ¤¢'};
                G.stats.vomitMade++; 
            }
            renderScene(); 
        },2000); 
    }
    
    function serve(i){ 
        let p=G.pots[G.selPot]; 
        let c=G.seats[i]; 
        if(!p||p.status!=='done')return toast('æ²¡å¥½'); 
        if(!c)return; 
        
        if(c.type === 'alien') {
            if(p.res.n === 'é»‘æš—æ–™ç†') {
                G.money += 100;
                G.totalEarned += 100;
                G.stats.earn += 100;
                toast('ğŸ‘½: %**#ï¿¥@! (+$100)');
                finishServe(i);
            } else {
                toast('ğŸ‘½: ...? (åªåƒğŸ¤¢)');
            }
            return;
        }

        if(c.dish.n===p.res.n){ 
            if(G.lv < 50) {
                let xpGain = 0.5;
                if(G.lv < 10) xpGain = 5;
                else if(G.lv < 20) xpGain = 4;
                else if(G.lv < 35) xpGain = 3;
                else if(G.lv < 45) xpGain = 1.5;
                
                G.xp += xpGain;
                if(G.xp >= 100){
                    G.xp=0;
                    G.lv++;
                    toast(`å‡çº§ Lv.${G.lv}!`);
                }
            }

            let fM=FACILITIES[G.facLv-1].mult; 
            let tM=p.res.id===G.trend.id?2:1; 
            let earn=Math.floor(p.res.p*fM*tM); 
            
            if(c.type === 'critic') {
                earn *= 4;
                toast(`ğŸ§ ç¾é£Ÿå®¶å¤§èµ +$${earn}`);
                G.stats.criticsServed++;
            } else {
                if(Math.random()<0.05){let tip=Math.round(earn*0.5);earn+=tip;toast(`ğŸ’– å°è´¹ +${tip}`);}else{toast(`+$${earn}`);}
            }
            
            if(c.type === 'alien') G.stats.aliensServed++;

            G.money+=earn; 
            G.totalEarned+=earn; 
            G.stats.earn+=earn; 
            finishServe(i);
        }else toast('ä¸è¦'); 
    }

    function finishServe(i) {
        G.seats[i]=null; 
        G.pots[G.selPot]={items:[],status:'idle',res:null}; 
        G.selPot=-1; 
        updateUI(); 
        checkAch(); 
        renderScene();
    }

    function customerLeave(i){ 
        if(!G.seats[i])return; 
        let c = G.seats[i];
        
        G.stats.angryLeaves++; 

        if(c.type === 'critic') {
            G.money = Math.max(0, G.money - 200);
            G.stats.penalty += 200;
            toast('ğŸ§ ç¾é£Ÿå®¶æ„¤æ€’ç¦»å¸­! -$200');
        } else {
            G.money=Math.max(0,G.money-5); 
            toast('å®¢äººèµ°äº† -5'); 
        }
        
        G.seats[i]=null; 
        updateUI(); 
        renderScene(); 
        checkDeadlock(); 
    }
    
    let loopId;
    let spawnTick = 0;
    let isEnding = false;

    function startBusiness(){ 
        let minDishes = G.lv >= 20 ? 5 : 3;
        if(G.menu.length < minDishes) return toast(`è‡³å°‘é€‰æ‹© ${minDishes} é“èœ`);

        closeModal(); 
        G.isPlaying=true; 
        isEnding = false;
        document.getElementById('homeTitle').classList.add('hidden'); 
        
        G.dailyFlags = { alien: false, critic: false };
        G.dailyEvents = {
            alien: Math.random() < 0.1, 
            critic: (G.lv >= 10 && G.facLv >= 2) && Math.random() < 0.05 
        };

        G.activeIngredients = new Set();
        G.menu.forEach(dish => {
            dish.req.forEach(ing => G.activeIngredients.add(ing));
        });
        if(G.trend) {
            G.trend.req.forEach(ing => G.activeIngredients.add(ing));
        }

        let base = 6;
        let bonus = Math.round(G.lv * 1.5);
        G.queue = Math.min(50, base + bonus);

        updateUI(); 

        G.seats=[null,null,null,null]; 
        G.selPot=-1; 
        G.stats.earn = 0;
        G.stats.penalty = 0;
        for(let i=0;i<2;i++) if(i<G.potsUnlocked)G.pots[i]={items:[],status:'idle',res:null}; else G.pots[i].status='locked'; 
        
        document.getElementById('homeNav').style.display='none'; 
        document.getElementById('gameNav').style.display='flex'; 
        document.getElementById('endBtn').style.display='block'; 
        
        renderScene(); 
        spawnRandom(); 
        if(loopId)clearInterval(loopId); 
        loopId=setInterval(loop, 50); 
    }
    
    function loop(){ 
        if(!G.isPlaying)return; 

        spawnTick++;
        if(spawnTick % 20 === 0) { 
            spawnRandom();
        }
        
        let allEmpty = true;
        G.seats.forEach((s, idx) => {
            if(s) {
                allEmpty = false;
                let passed = Date.now() - s.spawnTime;
                let pct = 100 - (passed / s.maxTime * 100);
                
                let bar = document.getElementById(`timer-${idx}`);
                if(bar) {
                    bar.style.width = Math.max(0, pct) + '%';
                    if(pct < 30) bar.style.background = '#e53935'; 
                }

                if(passed >= s.maxTime) {
                    customerLeave(idx);
                }
            }
        });

        checkDeadlock(); 
        
        if(G.queue===0 && allEmpty && !isEnding) {
            isEnding = true;
            setTimeout(endDay, 1000); 
        }
    }

    function spawnRandom() {
        let available = [];
        for(let i=0; i<G.seatsUnlocked; i++) {
            if(!G.seats[i]) available.push(i);
        }
        
        if(available.length > 0) {
            let seatIdx = available[Math.floor(Math.random() * available.length)];
            
            if(G.dailyEvents.alien && !G.dailyFlags.alien && Math.random() < 0.2) {
                spawn(seatIdx, 'alien');
                G.dailyFlags.alien = true;
                return;
            }
            if(G.dailyEvents.critic && !G.dailyFlags.critic && Math.random() < 0.2) {
                spawn(seatIdx, 'critic');
                G.dailyFlags.critic = true;
                G.queue--; 
                updateUI();
                return;
            }

            if(G.queue > 0 && Math.random() > 0.4) {
                spawn(seatIdx, 'normal');
                G.queue--;
                updateUI(); 
            }
        }
    }

    function checkDeadlock() {
        let active = G.seats.filter(c => c);
        if (active.length === 0) return;

        let hope = false;
        for (let c of active) {
            if(c.type === 'alien') { hope = true; break; }

            let inPot = G.pots.some(p => {
                if (p.status === 'done' && p.res && p.res.id === c.dish.id) return true;
                let pm = p.items.slice().sort().join('');
                let rm = c.dish.req.slice().sort().join('');
                return (p.status === 'cooking' || (p.status === 'idle' && p.items.length > 0)) && pm === rm;
            });
            if (inPot) { hope = true; break; }

            let canMake = c.dish.req.every(k => G.inv[k] > 0);
            if (canMake) { hope = true; break; }

            let canComplete = G.pots.some(p => {
                if (p.status !== 'idle' || p.items.length === 0) return false;
                let pItems = [...p.items];
                let reqItems = [...c.dish.req];
                let match = true;
                for(let it of pItems){
                    let idx = reqItems.indexOf(it);
                    if(idx > -1) reqItems.splice(idx, 1); 
                    else { match = false; break; } 
                }
                if(!match) return false;
                return reqItems.every(k => G.inv[k] > 0);
            });
            if (canComplete) { hope = true; break; }
        }

        if (!hope) {
            triggerGameOver(active[0].dish.n);
        }
    }

    function triggerGameOver(n){ G.isPlaying=false; clearInterval(loopId); document.getElementById('gameOverMsg').innerText=`æ— æ³•åˆ¶ä½œ: ${n}`; document.getElementById('modalGameOver').style.display='flex'; }
    function closeGameOver(){ document.getElementById('modalGameOver').style.display='none'; endDay(); }
    
    function spawn(i, type = 'normal'){ 
        if(G.seats[i])return; 
        let d=G.menu[Math.floor(Math.random()*G.menu.length)]; 
        if(G.menu.includes(G.trend)&&Math.random()<0.3)d=G.trend; 
        const SHIRTS=['#90caf9','#a5d6a7','#ce93d8','#ffcc80']; 
        
        let customer = {
            type: type,
            dish:d, 
            face:['ğŸ‘±','ğŸ‘µ','ğŸ‘¨','ğŸ§’'][Math.floor(Math.random()*4)], 
            shirt:SHIRTS[Math.floor(Math.random()*4)],
            spawnTime: Date.now(),
            maxTime: 15000 
        };

        if(type === 'alien') {
            customer.face = 'ğŸ‘½';
            customer.dish = { n: 'é»‘æš—æ–™ç†', i: 'ğŸ¤¢' };
            customer.maxTime = 20000;
        } else if (type === 'critic') {
            customer.face = 'ğŸ§';
            customer.dish = G.trend; 
        }

        G.seats[i] = customer;
        renderScene(); 
    }

    function endDay(){ 
        clearInterval(loopId); 
        G.isPlaying=false; 
        G.seats=[null,null,null,null]; 
        G.pots.forEach(p => { if(p.status !== 'locked') { p.items = []; p.status = 'idle'; p.res = null; } });
        renderScene(); 
        saveGame(); 
        document.getElementById('homeTitle').classList.remove('hidden'); 
        document.getElementById('modalReport').style.display='flex'; 
        document.getElementById('repMoney').innerText=G.stats.earn;
        let pText = G.stats.penalty > 0 ? `(å«ç½šæ¬¾: -$${G.stats.penalty})` : '';
        document.getElementById('repPenalty').innerText = pText;
    }

    function nextDay(){ 
        G.day++; 
        G.menu=[]; 
        let u=RECIPES.filter(r=>r.lv<=G.lv); 
        G.trend=u[Math.floor(Math.random()*u.length)]||RECIPES[0]; 
        
        G.prevPrices = {...G.prices};
        for(let k in ITEMS) {
            let base = ITEMS[k].p;
            let factor = 0.85 + Math.random() * 0.35;
            G.prices[k] = Math.ceil(base * factor);
        }

        saveGame(); 
        closeModal(); 
        document.getElementById('homeNav').style.display='block'; 
        document.getElementById('gameNav').style.display='none'; 
        document.getElementById('endBtn').style.display='none'; 
        init(); 
    }
    
    function checkAndOpenMenu() { try { openMenu(); } catch(e) { alert('å‡ºé”™å•¦ï¼Œè¯·é‡ç½®å­˜æ¡£'); console.error(e); } }

    function showCommon(t, h) { document.getElementById('commTitle').innerText=t; document.getElementById('commBody').innerHTML=h; document.getElementById('modalCommon').style.display='flex'; }
    function openMarket() { 
        let header = `<p style="text-align:center;color:#795548;font-size:14px;margin-bottom:10px;font-weight:bold">ä»Šæ—¥ä»·æ ¼å¦‚ä¸‹ï¼Œæ¬¢è¿é‡‡è´­å“¦ï¼</p>`;
        let grid = `<div class="list-grid">${Object.keys(ITEMS).map(k=>{
            let price = G.prices[k];
            let old = G.prevPrices[k] || ITEMS[k].p;
            let diff = price - old;
            let diffText = diff > 0 ? `+$${diff}` : (diff < 0 ? `-$${Math.abs(diff)}` : '');
            let arrow = diff > 0 ? `<span style="color:#e53935">â¬†${diffText}</span>` : (diff < 0 ? `<span style="color:#43a047">â¬‡${diffText}</span>` : '<span style="color:#aaa">-</span>');
            return `<div class="grid-item" onclick="buyItem('${k}')">
                <div style="font-size:24px">${ITEMS[k].i}</div>
                <div>${ITEMS[k].n}</div>
                <div style="color:orange;font-weight:bold">$${price} <small style="font-size:10px">${arrow}</small></div>
                <div style="font-size:10px;color:#aaa">æ‹¥:${G.inv[k]}</div>
            </div>`
        }).join('')}</div>`;
        showCommon('ğŸ¥¦ èœå¸‚åœº (æ¯æ—¥æµ®åŠ¨)', header + grid); 
    }
    function buyItem(k) { if(G.money>=G.prices[k]){G.money-=G.prices[k];G.inv[k]++;updateUI();openMarket();}else toast('æ²¡é’±'); }
    function openWarehouse() { showCommon('ğŸ“¦ ä»“åº“', `<div class="list-grid">${Object.keys(ITEMS).map(k=>`<div class="grid-item"><div style="font-size:24px">${ITEMS[k].i}</div><div>${ITEMS[k].n}</div><div style="color:#888">x${G.inv[k]}</div></div>`).join('')}</div>`); }
    
    function openRecipes() { 
        showCommon('ğŸ“– é£Ÿè°±', `<div style="display:flex;flex-direction:column;gap:10px">${RECIPES.map(r=>{
            let l=G.lv<r.lv; 
            return `<div style="display:flex;align-items:center;padding:10px;border:1px solid #eee;border-radius:10px;opacity:${l?0.5:1}"><div style="font-size:24px;margin-right:10px">${l?'ğŸ”’':r.i}</div><div><b>${l?'???':r.n}</b> <span style="color:#ff7043;font-weight:bold;margin-left:5px">${l?'':'$'+r.p}</span><br><small style="color:#888">${l?`Lv.${r.lv}`:r.req.map(k=>ITEMS[k].i).join('')}</small></div></div>`
        }).join('')}</div>`); 
    }
    
    function openAchieve() { showCommon('ğŸ† æˆå°±', `<div style="display:flex;flex-direction:column;gap:10px">${ACHIEVEMENTS.map(a=>{let u=G.achieved.includes(a.id); return `<div style="display:flex;align-items:center;padding:10px;background:${u?'#fff8e1':'#f9f9f9'};border:1px solid ${u?'#ffca28':'#eee'};border-radius:10px"><div style="font-size:24px;margin-right:10px;filter:${u?'none':'grayscale(1)'}">${a.i}</div><div><b>${a.n}</b><br><small>${a.d}</small></div></div>`}).join('')}</div>`); }
    function openUpgrade() { showCommon('ğŸ—ï¸ è£…ä¿®', `<div style="display:flex;flex-direction:column;gap:10px">${FACILITIES.map(f=>{let cur=G.facLv===f.lv; return `<div style="display:flex;justify-content:space-between;padding:10px;border:1px solid ${cur?'#81c784':'#eee'};background:${cur?'#e8f5e9':'#fff'};border-radius:10px"><div><b>${f.name}</b><small> (${Math.round(f.mult*100)}%)</small></div>${cur?'<small>å½“å‰</small>':(G.facLv>f.lv?'<small>å·²è´­</small>':(G.lv<f.reqLv?`<small>Lv.${f.reqLv}</small>`:`<button onclick="buyFac(${f.lv})" style="background:#42a5f5;color:white;border:none;padding:2px 8px;border-radius:10px">å‡çº§ $${f.cost}</button>`))}</div>`}).join('')}</div>`); }
    function buyFac(lv) { let f=FACILITIES.find(x=>x.lv===lv); if(G.money>=f.cost){G.money-=f.cost;G.facLv=lv;updateUI();saveGame();openUpgrade();toast('æˆåŠŸ');}else toast('é’±ä¸å¤Ÿ'); }
    function openMenu() { 
        document.getElementById('menuTitle').innerText=`ğŸ“ èœå• (${G.menu.length}/8)`; 
        document.getElementById('menuSelection').innerHTML = RECIPES.filter(r=>r.lv<=G.lv).map(r=>{
            let sel=G.menu.includes(r);
            return `<div class="grid-item ${sel?'sel':''}" onclick="togMenu('${r.id}')"><div style="font-size:24px">${r.i}</div><div>${r.n}</div>${r.id===G.trend.id?'ğŸ”¥':''}</div>`
        }).join('');
        document.getElementById('modalMenu').style.display='flex';
    }
    window.togMenu = function(id) { 
        let r=RECIPES.find(x=>x.id===id); 
        if(G.menu.includes(r))G.menu=G.menu.filter(x=>x!==r); 
        else{
            if(G.menu.length>=8)return toast('æœ€å¤šé€‰8é“'); 
            G.menu.push(r);
        } 
        openMenu(); 
    }
    
    function closeModal(){document.querySelectorAll('.modal-mask').forEach(e=>e.style.display='none');}
    function toast(m){let t=document.getElementById('toast');t.innerText=m;t.style.opacity=1;setTimeout(()=>t.style.opacity=0,1000);}
    
    function checkAch(){ 
        ACHIEVEMENTS.forEach(a=>{
            if(!G.achieved.includes(a.id)&&a.c(G)){
                G.achieved.push(a.id);
                G.money += 100; 
                updateUI();
                toast(`ğŸ† ${a.n} (é‡‘å¸+100)`);
            }
        }); 
        saveGame(); 
    }

    init();
</script>
</body>
</html>
